#!/usr/bin/env bash
set -euo pipefail

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì‚¬ìš©ë²• (í”„ë¡œì íŠ¸ ë¡œì»¬)
#   ./gitx "[prefix] : Your commit message"   # ì „ì²´ ì›Œí¬í”Œë¡œìš° (add â†’ commit â†’ push)
#   ./gitx commit "[prefix] : Your commit"    # git add â†’ commit
#   ./gitx push                               # git fetch â†’ push
#   ./gitx reset                            # ë¡œì»¬ ë³€ê²½ì‚¬í•­ ë²„ë¦¬ê¸° (reset --hard, clean -fd)
#   ./gitx merge                              # í˜„ì¬ ë¸Œëœì¹˜ë¥¼ main ë¸Œëœì¹˜ë¡œ ë³‘í•©
#   ./gitx fetch                              # ëª¨ë“  ì›ê²© ì €ì¥ì†Œ fetch (git fetch --all)
#   ./gitx checkout [branchëª…]                # ìƒˆ ë¸Œëœì¹˜ ìƒì„± ë° ì²´í¬ì•„ì›ƒ
#   ./gitx merge-from <source-branch>         # <source-branch>ë¥¼ í˜„ì¬ ë¸Œëœì¹˜ì— ë³‘í•© & í‘¸ì‹œ
#   ./gitx abort                              # í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë³‘í•© ì·¨ì†Œ (git merge --abort)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

do_commit() {
  git add .
  if [[ -z "${1:-}" ]]; then
    echo "â—ï¸ commit ë©”ì‹œì§€ë¥¼ \"[prefix] : message\" í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”."
    exit 1
  fi
  git commit -m "$1"
}

do_push() {
  git fetch
  branch=$(git rev-parse --abbrev-ref HEAD)
  git push origin "$branch"
}

do_reset() {
  echo "âš ï¸  ë¡œì»¬ ë³€ê²½ì‚¬í•­ì„ ëª¨ë‘ ë²„ë¦½ë‹ˆë‹¤. (git reset --hard, git clean -fd)"
  read -p "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " confirm
  if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
    exit 1
  fi
  git reset --hard
  git clean -fd
  echo "âœ… ë¡œì»¬ ë³€ê²½ì‚¬í•­ì´ ëª¨ë‘ ë²„ë ¤ì¡ŒìŠµë‹ˆë‹¤."
}

do_merge() {
  current_branch=$(git rev-parse --abbrev-ref HEAD)
  if [[ "$current_branch" == "main" ]]; then
    echo "â—ï¸ í˜„ì¬ ë¸Œëœì¹˜ê°€ ì´ë¯¸ 'main'ì…ë‹ˆë‹¤. ë³‘í•©í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤."
    exit 1
  fi

  # ë‘ ë²ˆì§¸ ì¸ìë¡œ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ë°›ê±°ë‚˜, ê¸°ë³¸ ë©”ì‹œì§€ ì‚¬ìš©
  merge_msg="${2:-"Merge branch '$current_branch' into main"}"

  echo "â„¹ï¸ í˜„ì¬ ë¸Œëœì¹˜ '$current_branch'ë¥¼ 'main' ë¸Œëœì¹˜ë¡œ ë³‘í•©í•©ë‹ˆë‹¤."
  echo "â„¹ï¸ ì»¤ë°‹ ë©”ì‹œì§€: \"$merge_msg\""
  read -p "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " confirm
  if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
    exit 1
  fi

  echo "ğŸ”„ 'main' ë¸Œëœì¹˜ë¡œ ì´ë™ ì¤‘..."
  git checkout main
  echo "ğŸ”„ 'main' ë¸Œëœì¹˜ì˜ ìµœì‹  ë³€ê²½ì‚¬í•­ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
  git pull origin main
  echo "ğŸ”„ '$current_branch' ë¸Œëœì¹˜ë¥¼ 'main'ìœ¼ë¡œ ë³‘í•© ì¤‘..."
  git merge "$current_branch" --no-ff -m "$merge_msg"
  echo "âœ… '$current_branch' ë¸Œëœì¹˜ê°€ 'main'ìœ¼ë¡œ ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤."
  echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì„ ì›ê²© 'main' ë¸Œëœì¹˜ì— í‘¸ì‹œí•˜ë ¤ë©´ './gitx push'ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”."
}

do_fetch() {
  echo "ğŸ”„ ëª¨ë“  ì›ê²© ì €ì¥ì†Œì—ì„œ fetch ì¤‘..."
  git fetch --all
  echo "âœ… fetch ì™„ë£Œ."
}

do_checkout() {
  if [[ -z "${2:-}" ]]; then
    echo "â—ï¸ ì²´í¬ì•„ì›ƒí•  ë¸Œëœì¹˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”. ì‚¬ìš©ë²•: ./gitx checkout [branchëª…]"
    exit 1
  fi
  branch_name=$2
  echo "â„¹ï¸ ë¸Œëœì¹˜ '$branch_name' ìƒì„± í›„ ì²´í¬ì•„ì›ƒ í•©ë‹ˆë‹¤."
  git checkout -b "$branch_name"
  echo "âœ… í˜„ì¬ ë¸Œëœì¹˜: $(git rev-parse --abbrev-ref HEAD)"
}

do_merge_from() {
  if [[ -z "${2:-}" ]]; then
    echo "â—ï¸ ë³‘í•©í•  ì†ŒìŠ¤ ë¸Œëœì¹˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”. ì‚¬ìš©ë²•: ./gitx merge-from <source-branch>"
    exit 1
  fi
  
  source_branch=$2
  current_branch=$(git rev-parse --abbrev-ref HEAD)
  
  # ì†ŒìŠ¤ ë¸Œëœì¹˜ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
  if ! git rev-parse --verify "$source_branch" &> /dev/null; then
    echo "â—ï¸ ë¸Œëœì¹˜ '$source_branch'ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
    exit 1
  fi
  
  echo "â„¹ï¸ ì†ŒìŠ¤ ë¸Œëœì¹˜ '$source_branch'ë¥¼ í˜„ì¬ ë¸Œëœì¹˜ '$current_branch'ì— ë³‘í•©í•©ë‹ˆë‹¤."
  read -p "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " confirm
  if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
    exit 1
  fi
  
  echo "ğŸ”„ ì†ŒìŠ¤ ë¸Œëœì¹˜ '$source_branch'ì˜ ìµœì‹  ë³€ê²½ì‚¬í•­ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
  git fetch origin "$source_branch"
  
  echo "ğŸ”„ '$source_branch' ë¸Œëœì¹˜ë¥¼ '$current_branch'ì— ë³‘í•© ì¤‘..."
  git merge "$source_branch"
  
  echo "âœ… '$source_branch' ë¸Œëœì¹˜ê°€ '$current_branch'ì— ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤."
  
  echo "ğŸ”„ ë³€ê²½ì‚¬í•­ì„ ì›ê²© '$current_branch' ë¸Œëœì¹˜ì— í‘¸ì‹œ ì¤‘..."
  git push origin "$current_branch"
  
  echo "âœ… ë³‘í•© ë° í‘¸ì‹œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
}

do_abort() {
  echo "â„¹ï¸ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë³‘í•©ì„ ì·¨ì†Œí•©ë‹ˆë‹¤."
  if git merge --abort; then
    echo "âœ… ë³‘í•©ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
  else
    echo "â—ï¸ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë³‘í•©ì´ ì—†ìŠµë‹ˆë‹¤."
    exit 1
  fi
}

cmd="${1:-}"

case "$cmd" in
  commit)
    if [[ -z "${2:-}" ]]; then
      echo "â—ï¸ commit ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì‚¬ìš©ë²•: ./gitx commit \"[prefix] : message\""
      exit 1
    fi
    do_commit "$2"
    ;;
  push)
    do_push
    ;;
  reset)
    do_reset
    ;;
  merge)
    do_merge "$@"
    ;;
  merge-from)
    do_merge_from "$@"
    ;;
  fetch)
    do_fetch
    ;;
  checkout)
    do_checkout "$@"
    ;;
  abort)
    do_abort
    ;;
  *)
    if [[ -z "$cmd" ]]; then
      echo "â—ï¸ ì‚¬ìš©ë²•: ./gitx commit/push/reset/merge/merge-from/fetch/checkout/abort ë˜ëŠ” ./gitx \"[prefix] : message\""
      exit 1
    elif [[ "$cmd" == *" : "* ]]; then
        # ì „ì²´ ì›Œí¬í”Œë¡œìš°: commit + push
        do_commit "$cmd"
        do_push
    else
        echo "â—ï¸ ì˜ëª»ëœ ëª…ë ¹ì–´ ë˜ëŠ” ì»¤ë°‹ ë©”ì‹œì§€ í˜•ì‹ì…ë‹ˆë‹¤. ì‚¬ìš©ë²•ì„ í™•ì¸í•˜ì„¸ìš”."
        echo "   ./gitx commit/push/reset/merge/merge-from/fetch/checkout/abort ë˜ëŠ” ./gitx \"[prefix] : message\""
        exit 1
    fi
    ;;
esac