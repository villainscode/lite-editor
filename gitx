#!/usr/bin/env bash
set -euo pipefail

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì‚¬ìš©ë²• (í”„ë¡œì íŠ¸ ë¡œì»¬)
#   ./gitx "[prefix] : Your commit message"   # ì „ì²´ ì›Œí¬í”Œë¡œìš° (add â†’ commit â†’ push)
#   ./gitx commit "[prefix] : Your commit"    # git add â†’ commit
#   ./gitx push                               # git fetch â†’ push (í˜„ì¬ ë¸Œëœì¹˜)
#   ./gitx discard                            # ë¡œì»¬ ë³€ê²½ì‚¬í•­ ë²„ë¦¬ê¸° (reset --hard, clean -fd)
#   ./gitx merge                              # í˜„ì¬ ë¸Œëœì¹˜ë¥¼ main ë¸Œëœì¹˜ë¡œ ë³‘í•©
#   ./gitx fetch                          # ëª¨ë“  ì›ê²© ì €ì¥ì†Œ fetch (git fetch --all)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

do_commit() {
  git add .
  if [[ -z "${1:-}" ]]; then
    echo "â—ï¸ commit ë©”ì‹œì§€ë¥¼ \"[prefix] : message\" í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”."
    exit 1
  fi
  git commit -m "$1"
}

do_push() {
  git fetch # í˜„ì¬ ë¸Œëœì¹˜ í‘¸ì‹œ ì „ì—ëŠ” í•´ë‹¹ ì›ê²© ë¸Œëœì¹˜ë§Œ fetch í•´ë„ ì¶©ë¶„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  branch=$(git rev-parse --abbrev-ref HEAD)
  git push origin "$branch"
}

do_discard() {
  echo "âš ï¸  ë¡œì»¬ ë³€ê²½ì‚¬í•­ì„ ëª¨ë‘ ë²„ë¦½ë‹ˆë‹¤. (git reset --hard, git clean -fd)"
  read -p "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " confirm
  if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
    exit 1
  fi
  git reset --hard
  git clean -fd
  echo "âœ… ë¡œì»¬ ë³€ê²½ì‚¬í•­ì´ ëª¨ë‘ ë²„ë ¤ì¡ŒìŠµë‹ˆë‹¤."
}

do_merge() {
  current_branch=$(git rev-parse --abbrev-ref HEAD)
  if [[ "$current_branch" == "main" ]]; then
    echo "â—ï¸ í˜„ì¬ ë¸Œëœì¹˜ê°€ ì´ë¯¸ 'main'ì…ë‹ˆë‹¤. ë³‘í•©í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤."
    exit 1
  fi

  echo "â„¹ï¸ í˜„ì¬ ë¸Œëœì¹˜ '$current_branch'ë¥¼ 'main' ë¸Œëœì¹˜ë¡œ ë³‘í•©í•©ë‹ˆë‹¤."
  read -p "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " confirm
  if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
    exit 1
  fi

  echo "ğŸ”„ 'main' ë¸Œëœì¹˜ë¡œ ì´ë™ ì¤‘..."
  git checkout main
  echo "ğŸ”„ 'main' ë¸Œëœì¹˜ì˜ ìµœì‹  ë³€ê²½ì‚¬í•­ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
  git pull origin main # main ë¸Œëœì¹˜ ìµœì‹ í™”
  echo "ğŸ”„ '$current_branch' ë¸Œëœì¹˜ë¥¼ 'main'ìœ¼ë¡œ ë³‘í•© ì¤‘..."
  git merge "$current_branch" --no-ff # --no-ff ì˜µì…˜ìœ¼ë¡œ merge commitì„ ë‚¨ê¹ë‹ˆë‹¤.
  echo "âœ… '$current_branch' ë¸Œëœì¹˜ê°€ 'main'ìœ¼ë¡œ ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤."
  echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì„ ì›ê²© 'main' ë¸Œëœì¹˜ì— í‘¸ì‹œí•˜ë ¤ë©´ './gitx push'ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”."
}

do_fetch() {
  echo "ğŸ”„ ëª¨ë“  ì›ê²© ì €ì¥ì†Œì˜ ë³€ê²½ì‚¬í•­ì„ ê°€ì ¸ì˜µë‹ˆë‹¤ (git fetch --all)..."
  git fetch --all
  echo "âœ… ëª¨ë“  ì›ê²© ì €ì¥ì†Œ fetch ì™„ë£Œ."
}

cmd="${1:-}"

case "$cmd" in
  commit)
    # commit ë©”ì‹œì§€ê°€ ì œê³µë˜ì—ˆëŠ”ì§€ í™•ì¸
    if [[ -z "${2:-}" ]]; then
      echo "â—ï¸ commit ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì‚¬ìš©ë²•: ./gitx commit \"[prefix] : message\""
      exit 1
    fi
    do_commit "$2"
    ;;
  push)
    do_push
    ;;
  discard)
    do_discard
    ;;
  merge)
    do_merge
    ;;
  fetch)
    do_fetch
    ;;
  *)
    if [[ -z "$cmd" ]]; then
      echo "â—ï¸ ì‚¬ìš©ë²•: ./gitx commit/push/discard/merge/fetch ë˜ëŠ” ./gitx \"[prefix] : message\""
      exit 1
    # commit ë©”ì‹œì§€ í˜•ì‹ì¸ì§€ í™•ì¸ (ë‹¨ìˆœí™”ëœ ì²´í¬)
    elif [[ "$cmd" == *" : "* ]]; then
        do_commit "$cmd"
        do_push
    else
        echo "â—ï¸ ì˜ëª»ëœ ëª…ë ¹ì–´ ë˜ëŠ” ì»¤ë°‹ ë©”ì‹œì§€ í˜•ì‹ì…ë‹ˆë‹¤. ì‚¬ìš©ë²•ì„ í™•ì¸í•˜ì„¸ìš”."
        echo "   ./gitx commit/push/discard/merge/fetch ë˜ëŠ” ./gitx \"[prefix] : message\""
        exit 1
    fi
    ;;
esac