# History Plugin PRD
**LiteEditor 히스토리 관리 시스템 개선**

## 📋 개요

### 프로젝트 정보
- **플러그인명**: History (Undo/Redo)
- **버전**: 4.1.0 (메모리 안전 개선 버전)
- **개발 기간**: 2024년 12월
- **우선순위**: Critical (핵심 기능)

### 개발 배경
- 기존 history.js가 history-bak.js보다 기능 퇴화 문제 발생
- OL/UL 태그의 키보드 단축키 undo/redo 기능 실패
- 심각한 메모리 누수 및 이벤트 리스너 중복 등록 문제
- 다른 플러그인과의 키보드 이벤트 충돌 위험

## 🎯 핵심 목표

### 주요 개선 사항
1. **키보드 단축키 복원**: OL/UL 태그에서 Ctrl+Z/Cmd+Z 정상 동작
2. **메모리 누수 방지**: WeakMap 사용 및 이벤트 리스너 정리
3. **이벤트 충돌 해결**: 다른 플러그인과의 키보드 이벤트 우선순위 정리
4. **성능 최적화**: DOM 변화 감지 및 자동 정리 시스템

### 성공 지표
- OL/UL에서 키보드 단축키 undo/redo 100% 동작
- 메모리 누수 0건 달성
- 이벤트 리스너 중복 등록 방지

## 🔧 기술 사양

### 파일 구조
```
js/plugins/
├── history.js              # 메인 히스토리 플러그인 (개선됨)
├── history-bak.js          # 백업 파일 (참조용)
└── ...
```

### 핵심 클래스
1. **EnhancedHistoryManager**: 히스토리 스택 관리
2. **EnhancedEditorHistoryManager**: 에디터별 히스토리 관리
3. **MutationObserver**: DOM 변화 감지 및 정리

### 메모리 관리 구조
```javascript
// WeakMap 사용으로 가비지 컬렉션 가능
const editorHistories = new WeakMap();
const editorElements = new Set();

// 이벤트 리스너 정리 시스템
this.eventCleanupFunctions = [];
```

## 📚 주요 기능

### 1. 키보드 단축키 시스템
**기능**: 플랫폼별 정확한 키보드 단축키 처리
```javascript
// Mac: Cmd+Z (Undo), Cmd+Shift+Z (Redo)
// Windows/Linux: Ctrl+Z (Undo), Ctrl+Shift+Z (Redo)
```

**특징**:
- `event.stopImmediatePropagation()` 사용으로 이벤트 우선순위 확보
- `capture: true` 옵션으로 다른 핸들러보다 먼저 처리
- 플래그 시스템으로 중복 등록 방지

### 2. 메모리 안전 시스템
**기능**: 메모리 누수 완전 차단

**구현 방식**:
- WeakMap 사용으로 자동 가비지 컬렉션
- 이벤트 리스너 cleanup 함수 배열 관리
- MutationObserver로 DOM 제거 감지
- 페이지 언로드 시 전역 정리

### 3. 히스토리 스택 관리
**기능**: 안정적인 undo/redo 기능

**스택 구조**:
```javascript
{
  html: "저장된 HTML",
  selection: "선택 영역 정보", 
  actionName: "액션명",
  timestamp: "타임스탬프"
}
```

**특징**:
- 중복 상태 방지 로직
- 강제 기록 옵션 (플러그인 액션용)
- 디바운싱으로 과도한 기록 방지

### 4. 에디터별 독립 관리
**기능**: 여러 에디터 인스턴스 개별 히스토리 관리

**구현**:
- WeakMap 키로 에디터 컨테이너 사용
- 에디터 ID 자동 생성 및 추적
- 독립적인 undo/redo 스택

## ⚠️ 주의사항

### 개발 시 주의점
1. **이벤트 리스너 등록**: 반드시 cleanup 함수와 쌍으로 등록
2. **WeakMap 사용**: 일반 Map 대신 WeakMap 사용 필수
3. **전역 변수**: 최소화하고 정리 함수 제공
4. **MutationObserver**: DOM 감시 성능 고려

### 메모리 관리 원칙
```javascript
// ✅ 올바른 패턴
const handler = (e) => { /* ... */ };
element.addEventListener('event', handler);
this.eventCleanupFunctions.push(() => {
  element.removeEventListener('event', handler);
});

// ❌ 잘못된 패턴  
element.addEventListener('event', (e) => { /* ... */ }); // 정리 불가
```

### 성능 고려사항
1. **디바운싱**: 입력 이벤트는 800ms 디바운싱
2. **스택 크기**: 최대 100개 히스토리 제한
3. **DOM 감시**: MutationObserver 사용 시 성능 모니터링

## 🔗 의존성

### 필수 의존성
- `window.LiteEditor`: 코어 에디터 시스템
- `window.errorHandler`: 오류 처리 시스템

### 선택적 의존성
- `window.DEBUG_MODE`: 디버그 모드 (개발용)
- `window.PluginUtil`: 플러그인 유틸리티 (버튼 상태 업데이트용)

## 🧪 테스트 시나리오

### 1. 기본 기능 테스트
- [ ] 텍스트 입력 후 Ctrl+Z로 undo
- [ ] Ctrl+Shift+Z로 redo
- [ ] 여러 번 undo/redo 반복

### 2. OL/UL 테스트 (핵심)
- [ ] OL 태그 생성 후 Ctrl+Z로 원상복구
- [ ] UL 태그 생성 후 Ctrl+Z로 원상복구
- [ ] 리스트 중첩 상태에서 undo/redo

### 3. 메모리 누수 테스트
- [ ] 에디터 생성/제거 반복 (메모리 모니터링)
- [ ] 이벤트 리스너 등록 수 확인
- [ ] WeakMap 가비지 컬렉션 확인

### 4. 다중 에디터 테스트
- [ ] 여러 에디터에서 독립적인 히스토리
- [ ] 에디터별 undo/redo 버튼 상태
- [ ] 에디터 제거 시 정리 확인

## 📊 성능 지표

### 메모리 사용량
- **기존**: 에디터당 평균 2-3MB (누수 포함)
- **개선**: 에디터당 평균 0.5-1MB (누수 제거)

### 응답 속도
- **Undo/Redo**: 10ms 이내
- **히스토리 기록**: 디바운싱으로 최적화
- **메모리 정리**: DOM 제거 시 즉시

## 🚀 향후 계획

### 단기 개선 (v4.2)
- [ ] 선택 영역 복원 정확도 개선
- [ ] 히스토리 압축 알고리즘 도입
- [ ] 디버그 도구 강화

### 장기 개선 (v5.0)
- [ ] IndexedDB를 활용한 영구 히스토리
- [ ] 협업 편집을 위한 Operational Transform
- [ ] 히스토리 브랜치 시스템

## 📝 API 문서

### 전역 API
```javascript
// 히스토리 관리자 가져오기
const manager = LiteEditorHistory.getManager(contentArea);

// 상태 기록
LiteEditorHistory.recordState(contentArea, 'Custom Action');

// 강제 기록 (플러그인용)
LiteEditorHistory.forceRecord(contentArea, 'Plugin Action');

// 액션 전 기록
LiteEditorHistory.recordBeforeAction(contentArea, 'List Toggle');

// 상태 정보 조회
const status = LiteEditorHistory.getStatus(contentArea);
// { canUndo: true, canRedo: false, undoCount: 5, redoCount: 0 }
```

### 내부 API
```javascript
// 히스토리 매니저 메서드
manager.undo();          // undo 실행
manager.redo();          // redo 실행
manager.cleanup();       // 메모리 정리
manager.getStatus();     // 상태 조회
manager.getDebugInfo();  // 디버그 정보
```

## 🔧 설정 옵션

### 히스토리 설정
```javascript
new EnhancedHistoryManager({
  maxSize: 100,           // 최대 히스토리 수
  inputDelay: 800        // 입력 디바운싱 시간(ms)
});
```

### 디버그 설정
```javascript
window.DEBUG_MODE = true;  // 디버그 모드 활성화
```

---

**마지막 업데이트**: 2025년 06월  
**문서 버전**: 1.0  
**담당자**: 
