# Check List Plugin 개발 명세서

## 1. 개요

LiteEditor에서 사용하는 체크리스트 기능을 구현한 플러그인입니다. 선택한 텍스트 영역에 체크박스 리스트를 적용/해제하고, 들여쓰기 레벨 관리 및 체크박스 상태에 따른 텍스트 스타일 변경을 지원합니다.

## 2. 핵심 기능

### 2.1 체크리스트 토글
- 선택한 텍스트 블록에 체크박스 리스트 서식 적용/해제
- 서식 적용 후에도 원래 선택 영역 유지
- 다중 라인 선택 시 모든 라인이 균일하게 처리되어야 함
- 마지막 라인까지 체크박스가 적용되어야 함 (누락 방지)

### 2.2 체크박스 기능
- 체크박스 체크 시 해당 텍스트에 취소선(strike) 자동 적용
- 체크박스 해제 시 취소선 자동 제거
- 체크박스만 클릭 가능하고 라벨은 클릭해도 체크박스 상태가 변경되지 않음
- 각 체크박스는 고유 ID를 가지고 생성됨

### 2.3 들여쓰기 관리
- Tab 키: 선택된 체크리스트 아이템 들여쓰기
- Shift+Tab 키: 체크리스트 아이템 내어쓰기
- 들여쓰기 레벨에 따른 시각적 구분 (패딩 자동 조정)
- 마진 클래스 기반 들여쓰기 레벨 추적

### 2.4 특수 키 처리
- Enter 키: 새 체크리스트 아이템 생성
- 빈 아이템에서 Enter 키: 체크리스트 종료 및 일반 텍스트로 전환
- Tab/Shift+Tab: 현재 아이템 들여쓰기/내어쓰기
- Alt+K: 체크리스트 토글 단축키

## 3. 기술적 구현 사항

### 3.1 선택 영역 관리
- DOM 직접 조작 방식으로 체크리스트 생성/제거
- 마커 요소(`data-unwrap-marker`, `data-selection-marker`)를 사용한 위치 추적
- 콜랩스된 범위(선택 없음) 시 현재 블록 전체를 대상으로 처리
- 변환 후 정확한 선택 영역 복원 메커니즘

### 3.2 체크박스와 라벨 구현
- 체크박스와 라벨 연결 해제 (라벨 클릭 효과 제거)
- 유니크 ID 생성으로 체크박스-라벨 관계 설정
- 체크박스 상태 변경 이벤트 리스너에서 strike 태그 삽입/제거
- 체크박스-라벨 간 간격 및 스타일 일관성 유지

### 3.3 이벤트 처리
- 체크박스 change 이벤트 처리
- 키보드 이벤트(Enter, Tab) 캡처링
- 이벤트 버블링 제어 및 기본 동작 방지
- 쓰로틀링으로 빈번한 키 입력 시 성능 보장 (100ms)

### 3.4 포커스 유지 메커니즘
- 새 아이템 생성 후 적절한 포커스 이동
- 커서 위치 기억 및 복원
- 텍스트 노드 탐색 로직으로 정확한 커서 위치 지정
- 빈 텍스트 노드 처리 (제로 너비 공백 활용)

## 4. 개발 주의사항

### 4.1 선택 영역 처리
- 체크리스트 적용/해제 시 선택 영역이 변경되지 않도록 관리
- 마커 기반 선택 영역 복원 메커니즘 구현
- DOM 변경 후 setTimeout으로 안정적인 선택 영역 복원

### 4.2 체크박스 동작 제어
- 라벨 클릭이 체크박스에 영향을 주지 않도록 htmlFor 속성 제거
- 체크박스 이벤트 리스너에서 strike 태그 DOM 조작 시 주의
- 중복 이벤트 리스너 방지를 위한 _changeListener 속성 활용

### 4.3 스타일 관리
- 라벨 커서 스타일은 text로 설정하여 일반 텍스트처럼 보이게 함
- 체크 시 취소선 텍스트 스타일 일관성 유지
- 들여쓰기 레벨 변경 시 적절한 클래스 관리
- 기존 DOM 요소의 스타일 업데이트 로직 구현

### 4.4 키보드 핸들링 주의사항
- Tab 키 기본 동작 방지 (브라우저 포커스 이동 방지)
- Enter 키 처리 시 빈 항목 판별 로직 정확성 확보
- 쓰로틀링 적용 시 민감도와 성능 균형 고려
- 이벤트 전파 제어를 위한 stopPropagation 필수 적용

## 5. 요구사항 확인 목록

- [ ] 선택 영역에만 영향을 미치고 문서의 다른 부분은 변경되지 않아야 함
- [ ] 버튼 클릭으로 체크리스트 적용/해제 토글이 정상 작동해야 함
- [ ] 적용/해제 후에도 원래 선택한 영역이 정확히 유지되어야 함
- [ ] 반복 토글 시에도 모든 선택 라인이 정확히 처리되어야 함 (마지막 라인 누락 현상 없어야 함)
- [ ] 체크박스 클릭 시 텍스트에 취소선이 정확히 적용/해제되어야 함
- [ ] 라벨 클릭 시 체크박스 상태가 변경되지 않아야 함
- [ ] Tab/Shift+Tab으로 들여쓰기/내어쓰기가 정상 작동해야 함
- [ ] 빈 항목에서 Enter 키 입력 시 체크리스트에서 빠져나와야 함
- [ ] Alt+K 단축키가 체크리스트 토글로 정상 작동해야 함

## 6. 코드 스니펫

### 6.1 체크리스트 아이템 생성

```js
function createCheckListItem(text, level = 0) {
  // 체크박스 ID 생성
  const itemId = `checklist-item-${Date.now()}-${checklistItemCounter++}`;
  
  const itemContainer = document.createElement('div');
  itemContainer.className = 'checklist-item flex items-center my-1';
  itemContainer.setAttribute('data-indent-level', level);
  
  if (level > 0) {
    itemContainer.style.paddingLeft = `${level * 1.5}em`;
  }
  
  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.id = itemId;
  checkbox.className = 'mr-2';
  
  // label에 htmlFor 속성 제거로 클릭 연결 차단
  const label = document.createElement('label');
  // label.htmlFor = itemId; // 제거됨
  label.innerHTML = text;
  
  itemContainer.appendChild(checkbox);
  itemContainer.appendChild(label);
  
  return itemContainer;
}
```

### 6.2 체크박스 이벤트 리스너

```js
// 체크박스 상태 변경시 텍스트에 취소선 적용/해제
const changeListener = function() {
  const label = this.nextElementSibling;
  if (!label) return;
  
  if (this.checked) {
    // 취소선 적용
    if (!label.querySelector('strike')) {
      const strike = document.createElement('strike');
      strike.textContent = label.textContent;
      label.textContent = '';
      label.appendChild(strike);
    }
  } else {
    // 취소선 제거
    const strike = label.querySelector('strike');
    if (strike) {
      const text = document.createTextNode(strike.textContent);
      label.replaceChild(text, strike);
    }
  }
};
```

### 6.3 Enter 키 처리

```js
function handleEnterKey(item) {
  if (!item) return;
  
  // 현재 항목이 비어있는지 확인
  const isEmpty = isEmptyCheckListItem(item);
  
  if (isEmpty) {
    // 빈 체크리스트 항목이면 일반 텍스트 블록으로 전환
    const textDiv = document.createElement('p');
    textDiv.innerHTML = '<br>';
    
    item.replaceWith(textDiv);
    // 새 블록에 포커스
    setTimeout(() => {
      const range = document.createRange();
      range.setStart(textDiv, 0);
      range.collapse(true);
      
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
    }, 0);
  } else {
    // 내용이 있으면 새 체크리스트 아이템 생성
    const newItem = createCheckListItem('');
    item.after(newItem);
    maintainFocus(newItem);
  }
}
```

## 7. 향후 개선사항

- 중첩 체크리스트 구조 지원 (부모-자식 관계)
- 체크박스 선택 상태 저장 및 복원 기능
- 다양한 체크박스 스타일 및 테마 지원
- 모바일 터치 제스처 최적화
- 체크된 항목 자동 정렬 옵션 (완료 항목 아래로 이동)
- 체크리스트 항목 드래그 앤 드롭 재정렬
- 체크 시 취소선 외 다양한 시각적 피드백 옵션
- 체크리스트 항목 일괄 체크/해제 기능
