# Code Plugin 개발 명세서 (PRD)

## 1. 개요

LiteEditor에서 사용하는 코드 서식(Code Formatting) 기능을 구현한 플러그인입니다. 선택한 텍스트 영역에 인라인 코드 태그를 적용하거나, 빈 커서 위치에 블록 레벨 코드 블록을 생성하는 기능을 제공합니다. HTML 구조 보존과 정확한 선택 영역 처리를 통해 사용자 경험을 최적화합니다.

## 2. 핵심 기능

### 2.1 이중 모드 코드 적용
- **빈 커서 모드**: 100% 너비의 편집 가능한 코드 블록 생성
- **선택 영역 모드**: 선택된 텍스트만 정확히 인라인 코드로 감싸기
- 선택 영역 유무에 따른 자동 모드 전환
- 서식 적용 후에도 원래 선택 영역 또는 커서 위치 유지

### 2.2 HTML 구조 보존 처리
- `<br>` 태그를 `\n`으로 변환하여 줄바꿈 정보 보존
- `security-manager.js`의 `escapeHtml`/`unescapeHtml` 함수 활용
- 다중 라인 선택 시 줄바꿈이 포함된 코드 블록 생성
- 원본 HTML 구조 손실 없는 안전한 DOM 조작

### 2.3 자동 줄바꿈 삽입 기능
- 코드 적용 후 다음 텍스트와 붙는 현상 방지
- 선택 영역 종료 지점 다음의 텍스트 노드 자동 감지
- 공백 없이 바로 이어지는 텍스트 발견 시 `<br>` 태그 자동 삽입
- 사용자가 기대하는 시각적 결과 자동 보정

### 2.4 키보드 이벤트 처리
- **Shift + Enter**: 코드 블록 내에서 줄바꿈 (`<br>` 태그 삽입)
- **Enter**: 코드 블록에서 탈출하여 새로운 `<p>` 태그 생성
- 코드 블록 내외부 구분을 통한 맥락적 키보드 동작
- 커서 위치 정확한 추적 및 복원

## 3. 기술적 구현 사항

### 3.1 CSS 스타일 통합 관리
- `core.css`의 기본 코드 스타일 완전 활용
- 인라인 스타일 최소화로 일관성 유지
- 빈 코드 블록만 `display: block`, `width: 100%` 오버라이드
- 다중 라인 코드에 `inline-block`, `pre-wrap` 스타일 적용

### 3.2 선택 영역 정밀 관리
- `extractContents()` 후 DOM 구조 변경에 따른 정보 손실 방지
- 원본 range 정보 사전 저장 및 활용
- `plugin-util.js`의 오프셋 계산 기능 활용한 백업 복원
- 실패 시 안전한 rollback 메커니즘

### 3.3 DOM 조작 최적화
- `range.deleteContents()` + `range.insertNode()` 패턴 사용
- `document.createElement()` 직접 사용으로 성능 최적화
- 임시 DOM 요소를 통한 HTML 분석 및 처리
- 메모리 효율적인 노드 복제 및 삽입

### 3.4 에러 처리 및 디버깅
- `window.errorHandler`를 통한 상세 로깅
- 단계별 처리 과정 컬러 로그 출력
- 예외 상황 시 자동 복원 로직
- 개발자 친화적 디버깅 정보 제공

## 4. 우선 요구사항

### 4.1 필수 요구사항
- 빈 커서에서 100% 너비 코드 블록 생성이 정확히 작동해야 함
- 선택 영역에서 정확한 범위만 코드로 감싸야 함
- 다중 라인 선택 시 줄바꿈이 보존되어야 함
- 코드 적용 후 다음 텍스트와 붙지 않아야 함
- Enter/Shift+Enter 키보드 동작이 기대한 대로 작동해야 함

### 4.2 추가 요구사항
- `core.css` 스타일과 완전히 일관된 시각적 표현
- 다른 플러그인과의 호환성 보장
- 브라우저별 동작 일관성 확보
- 성능 저하 없는 대용량 문서 처리
- 접근성 기준 준수

## 5. 알려진 문제점 및 해결 방안

### 5.1 다음 텍스트 붙음 현상
- **문제**: 더블클릭으로 선택한 텍스트에 코드 적용 시 다음 텍스트가 바로 붙음
- **원인**: `extractContents()` 후 DOM 구조 변경으로 인한 공백 정보 손실
- **해결책**: `insertLineBreakIfNeeded()` 함수로 자동 `<br>` 태그 삽입

### 5.2 CSS 일관성 문제
- **문제**: 인라인 스타일과 `core.css` 스타일 불일치
- **원인**: JavaScript에서 하드코딩된 스타일 값 사용
- **해결책**: `core.css` 기본값 활용, 필요시에만 오버라이드

### 5.3 HTML 구조 보존 복잡성
- **문제**: 줄바꿈 보존과 DOM 조작의 복잡성
- **원인**: `<br>` 태그와 텍스트 노드 혼재 처리의 어려움
- **해결책**: 단계별 변환 (`<br>` → `\n` → escape → `<br>`) 파이프라인

## 6. 테스트 시나리오

### 6.1 기본 기능 테스트
- 빈 커서에서 코드 블록 생성 및 편집
- 단일 라인 선택 후 코드 적용
- 다중 라인 선택 후 코드 적용
- 코드 블록 내에서 Shift+Enter 줄바꿈
- 코드 블록에서 Enter로 탈출

### 6.2 특수 케이스 테스트
- 더블클릭으로 단어 선택 후 코드 적용
- `<br>` 태그가 포함된 텍스트 선택 후 코드 적용
- 다른 서식(볼드, 이탤릭)과 함께 적용된 텍스트 처리
- 연속된 공백이 포함된 텍스트 처리

### 6.3 호환성 테스트
- Chrome, Firefox, Safari, Edge 브라우저 동작 확인
- 다른 플러그인(리스트, 테이블 등)과 함께 사용 시 호환성
- 모바일 브라우저에서의 터치 선택 후 코드 적용
- 키보드 접근성 확인

### 6.4 성능 테스트
- 대용량 문서(10,000+ 문자)에서 코드 적용 시간
- 연속된 코드 적용/해제 반복 시 메모리 사용량
- 복잡한 HTML 구조에서의 처리 성능

## 7. 개발 주의사항

### 7.1 구현 과정 주의사항
- CSS 스타일 우선순위: `core.css` 기본값 → 필요시 오버라이드
- DOM 조작 시 항상 원본 정보 백업 후 진행
- `security-manager.js` 함수 활용으로 XSS 방지
- 에러 발생 시 반드시 안전한 복원 로직 실행

### 7.2 잠재적 문제 영역
- 브라우저별 `contenteditable` 동작 차이
- 복잡한 중첩 HTML 구조에서의 선택 영역 계산
- 다른 플러그인과의 이벤트 충돌 가능성
- 메모리 누수 가능성 (이벤트 리스너, DOM 참조)

## 8. 향후 개선사항

### 8.1 기능 확장
- 코드 언어 감지 및 구문 강조 지원
- 코드 블록 테마 선택 기능
- 라인 번호 표시 옵션
- 코드 자동 완성 기능

### 8.2 사용성 개선
- 코드 블록 크기 조절 핸들
- 코드 복사/붙여넣기 최적화
- 코드 형식 자동 정리 기능
- 키보드 단축키 추가 (Ctrl+` 등)

### 8.3 기술적 개선
- 가상 DOM을 이용한 성능 최적화
- Web Worker를 활용한 대용량 텍스트 처리
- IndexedDB를 이용한 코드 스니펫 저장
- 실시간 협업 편집 지원

## 9. API 명세

### 9.1 공개 함수
```javascript
// 메인 코드 서식 적용 함수
function applyCodeFormat(contentArea)

// 빈 코드 블록 생성
function createEmptyCodeBlock(contentArea, range)

// 선택 영역 코드 감싸기
function wrapSelectedTextWithCode(contentArea, range)
```

### 9.2 유틸리티 함수
```javascript
// 자동 줄바꿈 삽입
function insertLineBreakIfNeeded(codeElement)

// 키보드 이벤트 설정
function setupCodeBlockKeyboardEvents(codeElement, contentArea)
```

### 9.3 단축키
- **Alt + C**: 코드 서식 토글
- **Enter**: 코드 블록에서 탈출 (코드 블록 내에서)
- **Shift + Enter**: 코드 블록 내 줄바꿈 (코드 블록 내에서)

---

**✨ 이 PRD는 현재 구현된 LiteEditor Code Plugin의 실제 스펙과 해결해야 할 과제들을 반영합니다.**
