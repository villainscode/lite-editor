# highlight Plugin 개발 명세서 (PRD)

   
# 핵심기능
- **선택 영역 모드**: 선택된 텍스트만 정확히 mark 태그로 감싸기
- 선택 영역 유무에 따른 자동 모드 전환, 이미 하일라이팅이 적용된 텍스트 위에 커서가 있을 경우 하일라이트 버튼 토글 (적용되었다는걸 시각적으로 보여줘야 함)
- 서식 적용 후에도 원래 선택 영역 또는 커서 위치 유지
- 커서 위치 정보를 저장하고, highlight 아이콘 클릭시 커서 위치에 정확히 mark 태그 적용 
- plugin-util.js 의 공통 함수를 이용해서 커서의 위치 계산, 블럭을 씌운 선택 영역의 start, end offset 계산, format_color_fill 버튼 클릭 후 블럭 영역 저장 후 mark 태그 적용 후에도 선택 영역은 유지되어야 함 

# HTML 구조 보존 처리
- `<br>` 태그를 `\n`으로 변환하여 줄바꿈 정보 보존
- `security-manager.js`의 `escapeHtml`/`unescapeHtml` 함수 등 필요한 코드는 재활용
- 다중 라인 선택 시 줄바꿈이 포함된 highlight mark 생성, 줄바꿈이 그대로 유지 되어야 함
- 원본 HTML 구조 손실 없는 안전한 조작, 드래그 영역의 텍스트 보존과 드래그 영역의 보존
- 하일라이트 영역에서 fontColor, fontFamily 적용시 태그가 그대로 적용되어야 하고 shift-enter 클릭시 mark, font 관련 태그가 적용되어있다면 그대로 유지
- enter 클릭시 mark 태그 블럭에서 빠져나와 기본 커서 형태를 유지 해야 함 

# 자동 줄바꿈 삽입 기능
- highlight 적용 후 다음 라인의 텍스트와 붙는 현상 방지. 지정된 영역에 정확히 하일라이팅 적용 후 다음 라인에 있는 텍스트가 옆으로 붙으면 안됌 
- 선택 영역 종료 지점 다음의 텍스트 노드 자동 감지
- 하일라이트 적용 후 아래 라인의 텍스트가 공백 없이 바로 이어질 경우 `<br>` 태그 자동 삽입
- 사용자가 기대하는 시각적 결과 자동 보정
- 더블 클릭시 아래 라인의 텍스트가 옆으로 붙지 않도록 문장의 끝 부분에서 줄바꿈 처리, 아래 라인이 없을 경우 아무런 처리 하지 않아도 됌 

# 키보드 이벤트 처리
- **Shift + Enter**: highlight 블록 내에서 줄바꿈 (`<br>` 태그 삽입)
- **Enter**: highlight 블록에서 탈출하여 새로운 `<p>` 태그 생성
- highlight 블록 내외부 구분을 통한 맥락적 키보드 동작
- 커서 위치 정확한 추적 및 복원

### 3.2 선택 영역 정밀 관리
- `extractContents()` 후 DOM 구조 변경에 따른 정보 손실 방지
- 원본 range 정보 사전 저장 및 활용
- `plugin-util.js`의 오프셋 계산 기능 활용한 백업 복원
- 실패 시 안전한 rollback 메커니즘

#  DOM 조작 최적화
- `range.deleteContents()` + `range.insertNode()` 패턴 사용
- `document.createElement()` 직접 사용으로 성능 최적화
- 임시 DOM 요소를 통한 HTML 분석 및 처리
- 메모리 효율적인 삽입

- `core.css` 스타일과 완전히 일관된 시각적 표현
- 다른 플러그인과의 호환성 보장
- 브라우저별 동작 일관성 확보
- 성능 저하 없는 대용량 문서 처리
- 접근성 기준 준수


#  알려진 문제점 및 해결 방안

## 다음 텍스트 붙음 현상
- **문제**: 더블클릭으로 선택한 텍스트에 highlight 적용 시 다음 텍스트가 바로 붙음
- **원인**: `extractContents()` 후 DOM 구조 변경으로 인한 공백 정보 손실
- **해결책**: `insertLineBreakIfNeeded()` 함수로 자동 `<br>` 태그 삽입

## CSS 일관성 문제
- **문제**: 인라인 스타일과 `core.css` 스타일 불일치
- **원인**: JavaScript에서 하드코딩된 스타일 값 사용
- **해결책**: `core.css` 기본값 활용, 필요시에만 오버라이드

## HTML 구조 보존 복잡성
- **문제**: 줄바꿈 보존과 DOM 조작의 복잡성
- **원인**: `<br>` 태그와 텍스트 노드 혼재 처리의 어려움
- **해결책**: 단계별 변환 (`<br>` → `\n` → escape → `<br>`) 파이프라인

# 테스트 시나리오

## 기본 기능 테스트
- 빈 커서에서 highlight 클릭시 mark 태그 생성 및 편집
- 단일 라인 선택 후 highlight 적용
- 다중 라인 선택 후 highlight 적용, 줄바꿈 유지 
- highlight블록 내에서 Shift+Enter 줄바꿈 후 적용된 태그 유지 
- highlight 블록에서 Enter로 mark 태그 탈출 

## 특수 케이스 테스트
- 더블클릭으로 단어 선택 후 highlight 적용시 위, 아래 태그를 분석하여, 아래의 태그가 옆라인으로 붙지 않도록 처리 
- `<br>` 태그가 포함된 텍스트 선택 후 highlight 적용
- 다른 서식(볼드, 이탤릭)과 함께 적용된 텍스트 처리
- font color, font family 적용시에도 Shift+Enter 줄바꿈 후 적용한 컬러, 폰트 유지 되어야 함 
- 커서가 mark 태그가 적용된 영역에 진입했을 때 format_color_fill 버튼의 class active 변경, mark 영역 밖으로 나갈 경우 원상복구 (기본값 유지)