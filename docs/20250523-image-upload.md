# Lite Editor Image Upload 기능 명세서 - 2025.05.23

## 개요

Lite Editor의 이미지 업로드 플러그인은 문서 편집 중 이미지를 쉽게 추가하고 관리할 수 있는 기능을 제공합니다. 이미지를 URL이나 로컬 파일에서 삽입할 수 있으며, 드래그 앤 드롭으로 재배치할 수 있습니다. 이 문서는 이미지 업로드 플러그인의 기능과 구현 세부 사항을 설명합니다.

## 기능 명세

### 1. 이미지 삽입

- **URL 입력**: 웹 URL을 통한 이미지 삽입
- **파일 업로드**: 로컬 저장소에서 이미지 파일 선택 및 업로드
- **삽입 위치**: 현재 커서 위치 또는 선택된 영역에 이미지 삽입
- **이미지 컨테이너**: 이미지는 크기 조절 가능한 컨테이너에 삽입됨

### 2. 이미지 관리

- **선택 기능**: 이미지 클릭 시 시각적 선택 피드백 제공
- **크기 조절**: 삽입된 이미지의 크기를 사용자가 조절 가능
- **드래그 앤 드롭**: 에디터 내에서 이미지 위치 이동 가능

### 3. 모달 인터페이스

- **경량 모달**: 2025년 4월 리팩토링된 컴팩트한 모달 시스템 활용
- **입력 방식**: URL 입력 필드와 파일 선택 버튼 제공
- **키보드 지원**: Enter 키로 URL 이미지 삽입, ESC 키로 모달 닫기

### 4. 드래그 앤 드롭 인터페이스

- **드롭 인디케이터**: 이미지 드래그 시 삽입 위치를 시각적으로 표시
- **빈 영역 처리**: 텍스트가 없는 영역에도 정확한 드롭 위치 표시
- **성능 최적화**: 애니메이션 프레임 기반 스로틀링으로 부드러운 UX 제공

## 구현 세부 사항

### 모듈 구조

```
(function() {
    // 1. 상수 및 변수 선언 영역
    // 2. 모달 템플릿 
    // 3. 유틸리티 함수
    // 4. 이벤트 핸들러 설정
    // 5. 모달 생성 및 표시
    // 6. 이미지 드래그 앤 드롭 기능
    // 7. 플러그인 등록
})();
```

### 이미지 삽입 구현

- 이미지 삽입 시 다음 HTML 구조 생성:
  ```html
  <div class="image-wrapper" contenteditable="false" draggable="true" id="img-{timestamp}">
    <img src="{이미지 URL}" style="width: 100%; height: auto; display: block;">
  </div>
  ```

- 컨테이너에 적용된 스타일:
  ```css
  display: inline-block;
  position: relative;
  margin: 10px 0;
  max-width: 100%;
  resize: both;
  overflow: hidden;
  ```

### 드래그 앤 드롭 최적화

1. **빈 영역 전용 로직**:
   - `getClientRects().length === 0`일 때 특별 처리
   - 임시 `<span>` 요소를 삽입하여 정확한 좌표 계산

2. **성능 최적화**:
   - `requestAnimationFrame`을 사용한 스로틀 구현
   - 불필요한 DOM 업데이트 최소화

3. **인디케이터 개선**:
   - 에디터 내부에 상대적 위치로 드롭 인디케이터 배치
   - 깜빡이는 텍스트 커서 스타일 적용

### 모달 시스템 통합

- 2025년 4월 리팩토링된 경량 모달 시스템 활용
- 모달 내부 클릭은 전파 중단 (stopPropagation)
- 모달 외부 클릭 시 닫기 처리
- 애니메이션 효과 적용 (opacity 및 transform 전환)

## 코드 분석

### 주요 함수

1. **insertImage(src)**:
   - 이미지 삽입 컨테이너 및 이미지 요소 생성
   - 선택 영역 처리 및 커서 위치 조정
   - 에디터 변경 이벤트 발생

2. **initImageDragDrop()**:
   - 이미지 드래그 앤 드롭 기능 초기화
   - 이벤트 리스너 설정 (dragstart, dragover, drop, dragend)
   - 드롭 인디케이터 관리

3. **showDropIndicator(x, y)**:
   - 캐럿 위치 계산 및 빈 영역 처리
   - 임시 요소를 통한 정확한 좌표 구하기
   - 에디터 상대적 위치 계산

4. **selectImage(imageWrapper)**:
   - 이미지 선택 상태 관리
   - 시각적 피드백 제공 (outline 스타일)

### 스타일 처리

- **선택 상태**:
  ```css
  .image-wrapper[data-selected="true"] {
    outline: 2px solid #4285f4;
  }
  ```

- **드래그 상태**:
  ```css
  .image-wrapper.dragging {
    opacity: 0.5;
    outline: 2px dashed #4285f4;
  }
  ```

- **드롭 인디케이터**:
  ```css
  @keyframes cursorBlink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }
  ```

### 이벤트 핸들링 최적화

- **위임 패턴** 사용으로 이벤트 리스너 최소화
- **쓰로틀링** 기법으로 dragover 이벤트 최적화
- **버블링 제어**로 불필요한 이벤트 전파 방지

## 성능 및 사용성 고려사항

### 성능 최적화

1. **requestAnimationFrame** 활용:
   - 드래그 인디케이터 표시에 스로틀 적용
   - 렌더링 성능 개선 및 부드러운 움직임 제공

2. **이벤트 위임**:
   - 에디터 요소에 이벤트 위임으로 메모리 사용 최적화
   - 동적으로 추가되는 이미지에도 이벤트 처리 가능

3. **지연 초기화**:
   - 플러그인 등록 시 `setTimeout`으로 초기화 지연
   - 에디터가 완전히 로드된 후 기능 초기화

### 사용성 개선

1. **시각적 피드백**:
   - 이미지 선택, 드래그 중 상태를 시각적으로 표시
   - 드롭 위치를 깜빡이는 커서로 직관적으로 표시

2. **키보드 지원**:
   - Enter 키로 URL 이미지 빠르게 삽입
   - ESC 키로 모달 닫기

3. **빈 영역 처리**:
   - 텍스트가 없는 영역에도 정확한 드롭 위치 제공
   - 임시 요소 삽입으로 좌표 계산 정확도 향상

## 브라우저 호환성

- **표준 API 활용**:
  - 표준 Drag and Drop API 사용
  - Selection API 및 Range API 활용

- **다양한 브라우저 지원**:
  - Chrome, Safari, Edge: `document.caretRangeFromPoint` 사용
  - Firefox: `document.caretPositionFromPoint` 대체 구현

## 향후 개선 방향

1. **이미지 편집 기능 추가**:
   - 회전, 자르기, 필터 적용 등 기본 편집 기능
   - 이미지 속성(alt, title) 편집 인터페이스

2. **클립보드 통합**:
   - 클립보드에서 직접 이미지 붙여넣기 지원
   - 스크린샷 빠른 삽입 기능

3. **저장소 연동**:
   - 클라우드 스토리지 서비스 연동
   - 이미지 갤러리 및 관리 기능

4. **성능 추가 최적화**:
   - 이미지 리사이징 성능 개선
   - 대용량 이미지 자동 최적화

## 결론

이미지 업로드 플러그인은 Lite Editor의 핵심 기능으로, 사용자에게 직관적이고 효율적인 이미지 관리 경험을 제공합니다. 2025년 4월의 리팩토링을 통해 개선된 모달 시스템과 결합하여 더욱 가볍고 효율적인 UI를 제공하며, 특히 드래그 앤 드롭 기능의 최적화를 통해 사용자 경험을 크게 향상시켰습니다. 빈 영역 처리, 성능 최적화, 시각적 피드백 개선을 통해 사용자는 보다 직관적으로 이미지를 관리할 수 있게 되었습니다.
