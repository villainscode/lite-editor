# Lite Editor Worklog - 2025.05.15

## 개요

Lite Editor의 주요 플러그인 기능 개선 및 버그 수정 작업을 진행했습니다. 주로 코드 블록, 미디어, 이미지 업로드 플러그인의 스크롤 위치 관련 문제를 해결하고, JavaScript 코드 감지 기능을 개선했습니다. 이러한 변경은 에디터의 사용성과 안정성을 향상시키기 위해 수행되었습니다.

## 작업 내역

### 1. 코드 블록 플러그인 개선

코드 블록 삽입 시 발생하는 문제를 해결했습니다:
- JavaScript 코드 자동 감지 기능이 제대로 작동하지 않는 문제 수정
- `customDetect.js` 파일을 추가하여 JavaScript 문법 감지 패턴 확장
- 코드 블록 삽입 후 스크롤이 맨 위로 올라가는 문제 해결
- 원래 커서 위치를 저장하고 복원하는 메커니즘 구현

### 2. 미디어 플러그인 개선

YouTube 동영상 삽입 관련 문제를 해결했습니다:
- 동영상 URL 입력 후 OK 버튼 클릭 시 스크롤이 맨 위로 올라가는 문제 수정
- `restoreSelection()` 함수 호출이 누락된 부분 추가
- 불필요한 스크롤 위치 저장/복원 로직 제거
- DOM 조작 후 커서 위치를 정확히 복원하도록 수정

### 3. 이미지 업로드 플러그인 개선

이미지 삽입 후 스크롤 위치 문제를 해결했습니다:
- 이미지 삽입 시 스크롤이 맨 위로 올라가는 현상 수정
- 앵커 요소 기반 스크롤 위치 복원 메커니즘 구현
- 이미지 로드 이벤트와 타이머를 활용한 안정적인 스크롤 처리
- 선택 영역 관리 로직 개선

### 4. 플러그인 중복 코드 리팩토링 계획

여러 플러그인에서 발견된 코드 중복 문제를 식별하고 개선 계획을 수립했습니다:
- `saveSelection()`, `restoreSelection()`, `clearSelection()` 등 공통 함수 중복 확인
- 중복 코드를 `plugin-util.js`로 통합하는 방안 마련
- `codeBlock.js`에서 시작하여 알파벳순으로 플러그인 파일 리팩토링 작업 착수

## 코드 변경 상세 내역

### 코드 블록 자동 감지 개선 (customDetect.js)
```js
// 개선된 JavaScript 감지 정규식
['js', [/\b(console|await|async|function|export|import|this|class|for|let|const|map|join|require)\b/g, 10]],
```

### 미디어 플러그인 스크롤 문제 해결 (media.js)
```js
// 변경 전 - 선택 영역 복원 누락
function insertYouTubeVideo(url, contentArea) {
  try {
    // YouTube ID 추출
    const videoId = parseYouTubeID(url);
    if (!videoId) return;
    
    try {
      contentArea.focus({ preventScroll: true });
    } catch (e) {
      contentArea.focus();
    }
    
    // restoreSelection() 호출 누락!
    
    // ... 나머지 코드
  }
}

// 변경 후 - 선택 영역 복원 추가
function insertYouTubeVideo(url, contentArea) {
  try {
    // YouTube ID 추출
    const videoId = parseYouTubeID(url);
    if (!videoId) return;
    
    try {
      contentArea.focus({ preventScroll: true });
    } catch (e) {
      contentArea.focus();
    }
    
    // 선택 영역 복원 추가
    restoreSelection();
    
    // ... 나머지 코드
  }
}
```

### 이미지 업로드 앵커 기반 스크롤 복원 (imageUpload.js)
```js
// 앵커 요소 기반 스크롤 복원 메커니즘
// 1. 먼저 앵커 요소 삽입
const anchorId = 'image-insert-anchor-' + Date.now();
const anchor = document.createElement('span');
anchor.id = anchorId;
anchor.style.display = 'inline';
anchor.style.width = '0';
anchor.style.height = '0';
anchor.style.overflow = 'hidden';
anchor.style.lineHeight = '0';
anchor.innerHTML = '&nbsp;';
range.insertNode(anchor);

// 2. 이미지 삽입 로직 수행...

// 3. 이미지 로드 완료 시 앵커 위치로 스크롤
img.onload = function() {
  const anchor = document.getElementById(anchorId);
  if (anchor) {
    anchor.scrollIntoView({ block: 'nearest', behavior: 'auto' });
    anchor.remove();
  }
};
```

## 코드 리뷰

### 스크롤 위치 관리 패턴

플러그인 작업 중 발견한 공통적인 문제는 DOM 조작 후 스크롤 위치가 올바르게 복원되지 않는 것이었습니다. 이를 해결하기 위해 다음 세 가지 접근법을 비교했습니다:

1. **픽셀 값 저장/복원**: `window.scrollY` 값을 저장했다가 `window.scrollTo()`로 복원하는 방법
   - 장점: 구현이 단순함
   - 단점: DOM 변경이 있을 경우 픽셀 값이 부정확해짐

2. **선택 영역 복원 의존**: `restoreSelection()`을 호출하고 브라우저의 자동 스크롤 기능에 의존하는 방법
   - 장점: 추가 코드가 적음
   - 단점: 브라우저마다 동작이 다르고 예측 불가능할 수 있음

3. **앵커 요소 기반 방식**: DOM에 앵커 요소를 삽입하고 `scrollIntoView()`로 해당 위치로 이동하는 방법
   - 장점: DOM 변경에도 안정적으로 작동함
   - 단점: 추가 요소와 코드가 필요함

이미지 업로드 플러그인에서는 세 번째 방식이 가장 효과적이었으며, 특히 이미지 로드 이벤트와 결합했을 때 안정적으로 작동했습니다.

### 플러그인 코드 중복 문제

여러 플러그인 파일을 검토한 결과, 선택 영역 관리 관련 함수(`saveSelection()`, `restoreSelection()`, `clearSelection()`)가 많은 플러그인에서 중복 구현되어 있음을 확인했습니다. 이런 중복은 코드 유지보수를 어렵게 하고 버그 발생 가능성을 높입니다. 해결 방안으로는:

1. **중앙화된 유틸리티 사용**: `plugin-util.js`에 모든 공통 기능을 구현하고 각 플러그인에서 사용
2. **점진적 리팩토링**: 각 플러그인을 하나씩 리팩토링하여 중앙화된 유틸리티를 사용하도록 수정
3. **일관된 인터페이스 적용**: 모든 플러그인이 동일한 패턴으로 선택 영역을 관리하도록 표준화

## 향후 과제

1. **플러그인 코드 중복 제거**: 알파벳순으로 각 플러그인 파일의 중복 코드 제거 작업 진행
2. **폴백 로직 중앙화**: 각 플러그인에서 구현한 폴백 로직을 `plugin-util.js`로 이동
3. **일관된 의존성 관리**: 모든 플러그인이 통일된 방식으로 유틸리티를 참조하도록 수정
4. **테스트 강화**: 스크롤 위치 복원 및 선택 영역 관리에 대한 테스트 케이스 추가
5. **코드 주석 개선**: 문제 해결 방법과 패턴에 대한 명확한 주석 추가

## 결론

이번 작업을 통해 Lite Editor의 주요 플러그인 기능이 안정적으로 개선되었습니다. 특히 코드 블록, 미디어, 이미지 업로드 플러그인의 스크롤 위치 문제를 해결함으로써 편집 경험이 크게 향상되었습니다. 또한 중복 코드 문제를 식별하고 향후 리팩토링 계획을 세움으로써 코드베이스의 품질 향상을 위한 기반을 마련했습니다. 앵커 요소 기반 스크롤 복원 메커니즘은 특히 DOM 변경이 많은 에디터 환경에서 유용한 패턴으로, 다른 플러그인에도 적용할 가치가 있습니다.

