# Lite Editor Worklog - 2025.05.15

## 개요

Lite Editor 코드베이스의 기능 개선 및 보안 강화 작업을 진행했습니다. 주요 작업으로는 미디어 플러그인과 이미지 업로드 플러그인 개선, XSS 취약점 방어 기능 구현, 모달 시스템 개선, 테스트 케이스 추가, 그리고 라이선스 변경이 포함되었습니다. 이러한 변경은 에디터의 기능성과 보안을 강화하고 더 나은 사용자 경험을 제공하기 위해 수행되었습니다.

## 작업 내역

### 1. 미디어 플러그인(media.js) 개선

YouTube 동영상 삽입 기능을 개선하여 사용자 경험을 향상시켰습니다:
- 동영상 크기 조절 기능 구현 (resize: both 속성 적용)
- 리사이즈 핸들 추가로 사용성 개선
- 인라인 스타일 적용으로 저장 시 크기 유지
- HTML 보안 검증 강화
- MutationObserver를 사용한 크기 변경 감지

이러한 변경으로 사용자가 삽입된 동영상의 크기를 직관적으로 조절하고, 저장 후에도 설정된 크기가 유지되는 기능을 제공합니다.

### 2. 이미지 업로드 플러그인(imageUpload.js) 개선

이미지 삽입 및 관리 기능을 개선했습니다:
- 이미지 크기 조절 기능 최적화
- 인라인 스타일 적용으로 저장 시 크기 속성 유지
- 리사이즈 핸들 UI 개선 및 사용성 강화
- 이미지 URL 보안 검증 강화
- 오류 메시지 처리 개선

이미지 삽입 시 테두리 스타일 관련 버그를 수정하고, 이미지 크기 조절 기능을 직관적으로 사용할 수 있도록 개선했습니다.

### 3. 보안 기능 강화 (security-manager.js)

XSS 공격 방지를 위한 보안 기능을 중앙 집중화하여 관리하도록 개선했습니다:
- URL 유효성 검사 함수(isValidUrl) 구현 및 강화
- HTML 태그 삽입 차단
- 위험한 URL 인코딩 패턴 감지 (%0A, %0D 등)
- 위험한 프로토콜 차단 (javascript:, data:, vbscript: 등)
- URL 디코딩을 통한 인코딩된 악성 코드 탐지
- 이미지 URL 검증 강화 (허용된 확장자 확인)

이 변경으로 모든 URL 입력에 대한 보안 검증을 일관되게 적용하여 XSS 취약점을 효과적으로 방어할 수 있게 되었습니다.

### 4. 링크 플러그인(link.js) 보안 개선

링크 삽입 기능의 보안을 강화했습니다:
- 중앙화된 보안 관리자(security-manager.js) 활용
- URL 유효성 검사 로직 개선
- 폴백 메커니즘 구현으로 security-manager.js 미로드 시에도 기본 보안 유지
- XSS 공격 방어 테스트 케이스 추가

이러한 개선으로 악의적인 링크 삽입을 효과적으로 차단하여 사용자를 보호합니다.

### 5. 모달 시스템 개선

모달 다이얼로그의 UI와 사용자 경험을 개선했습니다:
- 알림 및 확인 모달에 이모지 아이콘 추가 (⚠️, 💡)
- 타이틀과 내용의 디자인 개선
- 코드 중복 제거를 위한 공통 헬퍼 함수 추가
- 키보드 이벤트 처리 개선
- 오류 처리 강화

이러한 변경으로 모달 시스템의 시각적 피드백과 사용성이 향상되었습니다.

## 코드 변경 상세 내역

### 동영상 크기 조절 기능 추가
```javascript
// 래퍼 생성 - 클래스와 인라인 스타일 모두 적용
const wrapper = document.createElement('div');
wrapper.className = 'video-wrapper';

// 중요: width와 height를 style 속성에 직접 지정 (저장 시 유지)
wrapper.style.width = '640px';
wrapper.style.height = '360px';
wrapper.style.position = 'relative';
wrapper.style.margin = '10px 0';
wrapper.style.resize = 'both';
wrapper.style.overflow = 'hidden';
wrapper.style.border = '2px solid #e0e0e0';
wrapper.style.boxSizing = 'border-box';
wrapper.style.maxWidth = '100%';

// 리사이즈 핸들 요소 추가
const resizeHandle = util.dom.createElement('div', {
  className: 'video-resize-handle'
});
resizeHandle.style.position = 'absolute';
resizeHandle.style.right = '0';
resizeHandle.style.bottom = '0';
resizeHandle.style.width = '20px';
resizeHandle.style.height = '20px';
resizeHandle.style.backgroundImage = 'linear-gradient(135deg, transparent 50%, #4285f4 50%, #4285f4 100%)';
resizeHandle.style.cursor = 'nwse-resize';
resizeHandle.style.zIndex = '10';

wrapper.contentEditable = false;
```

### 보안 강화된 URL 검증 함수
```javascript
function isValidUrl(url) {
  if (!url) return false;
  
  // URL 디코딩 시도
  let decodedUrl;
  try {
    decodedUrl = decodeURIComponent(url);
  } catch (e) {
    decodedUrl = url;
  }
  
  // 1. HTML 태그 및 위험한 문자 감지 (원본 및 디코딩된 URL 모두 검사)
  if (/<[\s\S]*?>/i.test(url) || /<[\s\S]*?>/i.test(decodedUrl) || 
      /[<>]/i.test(url) || /[<>]/i.test(decodedUrl)) {
    return false;
  }
  
  // 2. 위험한 URL 인코딩 패턴 감지
  if (/%(?:3C|3E|00|0A|0D|27|22|60|28|29)/i.test(url)) {
    return false;
  }
  
  // 3. 위험한 프로토콜 차단
  if (/^(?:javascript|data|vbscript|file):/i.test(url) || 
      /^(?:javascript|data|vbscript|file):/i.test(decodedUrl)) {
    return false;
  }
  
  // 4. 위험한 자바스크립트 키워드 검사
  const dangerousKeywords = /\b(?:script|alert|eval|confirm|prompt|on\w+\s*=)/i;
  if (dangerousKeywords.test(url) || dangerousKeywords.test(decodedUrl)) {
    return false;
  }
  
  // 5. 기존 URL 형식 검증
  const domainRegex = /^(https?:\/\/)?(([a-zA-Z0-9\u3131-\u314E\uAC00-\uD7A3-]+\.)+([a-zA-Z\u3131-\u314E\uAC00-\uD7A3]{2,}))(:\d+)?(\/[^\s]*)?(\?.*)?$/;
  const invalidPrefixRegex = /^(https?:\/\/)?(wwww\.|ww\.|w{5,}\.|w{1,2}\.)/i;
  return domainRegex.test(url) && !invalidPrefixRegex.test(url);
}
```

### 모달 개선(아이콘 추가)
```javascript
// 공통 헬퍼 함수: 아이콘이 있는 타이틀 생성
function createIconTitle(icon, titleText, options = {}) {
  const iconSize = options.iconSize || '18px';
  const textSize = options.textSize || '16px';
  
  return `
    <div style="
      display: flex; 
      align-items: center; 
      gap: 8px;
      padding: 4px 0;
      line-height: 1.2;
    ">
      <span style="font-size: ${iconSize};">${icon}</span>
      <span style="
        font-size: ${textSize}; 
        font-weight: 600;
        vertical-align: middle;
      ">${titleText}</span>
    </div>
  `;
}

window.LiteEditorModal = {
  alert(message, options = {}) {
    const titleText = options.titleText || 'Alert';
    const formattedTitle = createIconTitle('⚠️', titleText, options);
    
    return showModal(MODAL_TYPES.ALERT, {
      ...options,
      message,
      title: options.title || formattedTitle,
      confirmText: options.confirmText || 'OK',
    });
  },

  confirm(message, options = {}) {
    const titleText = options.titleText || 'Confirm';
    const formattedTitle = createIconTitle('💡', titleText, options);
    
    return showModal(MODAL_TYPES.CONFIRM, {
      ...options,
      message,
      title: options.title || formattedTitle,
      confirmText: options.confirmText || 'OK',
      cancelText: options.cancelText || 'Cancel',
    });
  }
}
```

### 라이선스 변경

Modified Apache License 2.0 with Commons Clause
Commons Clause - Restriction on Redistribution
"Commons Clause" License Condition v1.0
The Software is provided to you by the Licensor under the License, as defined below, subject to the following condition.
Without limiting other conditions in the License, the grant of rights under the License will not include, and the License does not grant to you, the right to Sell the Software.

## 코드 리뷰

### 미디어 및 이미지 플러그인 개선 (media.js, imageUpload.js)

미디어 및 이미지 플러그인의 크기 조절 기능이 크게 개선되었습니다:

1. **인라인 스타일 사용**: 서버에 저장 시 크기 속성이 유지되도록 모든 스타일을 인라인으로 적용했습니다.
2. **리사이즈 UX 개선**: 시각적 피드백이 강화된 리사이즈 핸들을 구현했습니다.
3. **MutationObserver 활용**: 크기 변경 시 실시간으로 에디터 상태를 반영하도록 했습니다.
4. **크기 제한**: 반응형 디자인을 위해 최대 너비 제한을 적용했습니다.

이러한 개선으로 객체 삽입 후 크기 조절이 직관적이고 자연스러워졌으며, 저장 시 설정된 크기가 정확히 유지됩니다.

### 보안 시스템 개선 (security-manager.js)

보안 관련 기능을 중앙화하여 더 효율적인 관리와 일관된 보안 정책 적용이 가능해졌습니다:

1. **중앙 집중식 관리**: 모든 URL 검증 로직을 security-manager.js로 통합했습니다.
2. **다층적 방어**: HTML 태그, URL 인코딩, 위험한 프로토콜, 키워드 등 여러 층의 검증을 적용했습니다.
3. **디코딩 검사**: 인코딩된 형태의 XSS 공격도 감지할 수 있도록 URL 디코딩 후 검사를 수행합니다.
4. **확장성**: 새로운 보안 기능을 쉽게 추가할 수 있는 구조를 마련했습니다.

이 개선으로 모든 입력 지점에서 일관된 보안 검증이 이루어져 XSS 공격에 대한 방어력이 크게 향상되었습니다.

### 테스트 구현 (link-plugin.test.js)

테스트 케이스를 추가하여 코드의 신뢰성과 품질을 향상시켰습니다:

1. **보안 테스트**: 다양한 XSS 공격 패턴에 대한 방어 기능을 검증합니다.
2. **URL 유효성 검사**: 정상 URL과 비정상 URL에 대한 테스트를 수행합니다.
3. **DOM 통합 테스트**: 실제 환경에서의 플러그인 동작을 테스트합니다.
4. **코드 품질 관리**: 테스트를 통해 코드 변경에 따른 회귀를 방지합니다.

이 테스트 스위트를 통해 미래의 코드 변경에도 보안 기능이 지속적으로 유지될 수 있도록 했습니다.

## 향후 과제

1. **더 많은 플러그인에 테스트 추가**: 모든 플러그인에 대한 테스트 케이스를 확장해야 합니다.
2. **보안 스캔 자동화**: CI/CD 파이프라인에 보안 취약점 스캔을 통합해야 합니다.
3. **크로스 브라우저 호환성**: 다양한 브라우저에서의 기능 검증이 필요합니다.
4. **접근성 개선**: 스크린 리더 및 키보드 탐색 지원을 강화해야 합니다.
5. **성능 최적화**: 크기 조절 기능의 성능을 더 개선해야 합니다.

## 결론

이번 업데이트를 통해 Lite Editor의 기능성과 보안이 크게 향상되었습니다. 특히 미디어 및 이미지 객체의 크기 조절 기능, 중앙화된 보안 관리 시스템, 개선된 모달 UI는 에디터의 사용자 경험을 크게 개선했습니다. 또한 Modified Apache License with Commons Clause로 라이선스를 변경하여 소스 코드를 공개하면서도 재배포를 제한함으로써 프로젝트의 지속 가능한 발전을 도모했습니다. 향후 더 많은 테스트와 성능 최적화를 통해 에디터의 품질을 계속해서 향상시킬 계획입니다.